{% extends 'base.html' %}

{% load static %}

{% block content %}
<!DOCTYPE html>
<html lang="en">

<head>
    <title>{% block title %}Restaurants{% endblock %}</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    {% block extra_head %}{% endblock %}
</head>

<body>
    <div class="container mx-auto pt-24 pb-10">
        <h1 class="text-3xl font-bold text-center mb-10">Restaurants</h1>

        {% load custom_tags %}

        {% if user.is_authenticated and user|is_admin %}
        <form id="addRestaurantForm" class="space-y-4">
            <label for="name" class="block text-gray-700 font-medium">Restaurant Name:</label>
            <input type="text" id="name" name="name" required class="border border-gray-300 rounded-md p-2 w-full focus:border-blue-500 focus:outline-none">
        
            <label for="food_preference" class="block text-gray-700 font-medium">Food Preference:</label>
            <select id="food_preference" name="food_preference" required class="border border-gray-300 rounded-md p-2 w-full focus:border-blue-500 focus:outline-none">
                <option value="Chinese">Chinese</option>
                <option value="Indonesia">Indonesia</option>
                <option value="Japanese">Japanese</option>
                <option value="MiddleEastern">MiddleEastern</option>
                <option value="Western">Western</option>
            </select>
        
            <label for="average_price" class="block text-gray-700 font-medium">Average Price:</label>
            <input type="number" id="average_price" name="average_price" required class="border border-gray-300 rounded-md p-2 w-full focus:border-blue-500 focus:outline-none">
        
            <label for="rating" class="block text-gray-700 font-medium">Rating (out of 5):</label>
            <input type="number" id="rating" name="rating" min="0" max="5" step="0.1" required class="border border-gray-300 rounded-md p-2 w-full focus:border-blue-500 focus:outline-none">
        
            <label for="atmosphere" class="block text-gray-700 font-medium">Atmosphere:</label>
            <input type="text" id="atmosphere" name="atmosphere" required class="border border-gray-300 rounded-md p-2 w-full focus:border-blue-500 focus:outline-none">
        
            <label for="food_variety" class="block text-gray-700 font-medium">Food Variety:</label>
            <input type="text" id="food_variety" name="food_variety" required class="border border-gray-300 rounded-md p-2 w-full focus:border-blue-500 focus:outline-none">
        
            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">Add Restaurant</button>
        </form>
        {% else %}
        <p></p>
        {% endif %}


        <div class="mb-6">
            <input type="text" id="search-input" class="border border-gray-300 rounded-lg w-full p-2" placeholder="Search by name...">
        </div>

        <div class="mb-6">
            <select id="type-filter" class="border border-gray-300 rounded-lg w-full p-2">
                <option value="">All Food Preferences</option>
            </select>
        </div>

        <div id="restaurant-list" class="space-y-6"></div>
        <p id="no-restaurants" class="text-center text-gray-700 hidden">No restaurants found.</p>
    </div>

    {% block scripts %}
    <script>
        
        let restaurantsData = [];

        fetch("{% url 'get_restaurants' %}")  
        .then(response => response.json())
        .then(data => {
            restaurantsData = data.restaurants || [];

            // Populate food preference filter options
            const typeFilter = document.getElementById('type-filter');
            const types = new Set();
            restaurantsData.forEach(restaurant => {
                if (restaurant.food_preference) {
                    types.add(restaurant.food_preference.trim());
                }
            });
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeFilter.appendChild(option);
            });

            // Initial render
            renderRestaurants(restaurantsData);
        })
        .catch(error => {
            console.error('Error fetching restaurants:', error);
            const noRestaurantsMessage = document.getElementById('no-restaurants');
            noRestaurantsMessage.textContent = 'Failed to load restaurants.';
            noRestaurantsMessage.classList.remove('hidden');
        });

        // Function to render restaurants
        function renderRestaurants(restaurants) {
            const restaurantList = document.getElementById('restaurant-list');
            restaurantList.innerHTML = ''; // Clear previous content
            const noRestaurantsMessage = document.getElementById('no-restaurants');

            if (!restaurants || restaurants.length === 0) {
                noRestaurantsMessage.classList.remove('hidden');
                return;
            } else {
                noRestaurantsMessage.classList.add('hidden');
            }

            restaurants.forEach(restaurant => {
                const card = document.createElement('div');
                card.classList.add('flex', 'flex-col', 'md:flex-row', 'bg-white', 'rounded-lg', 'shadow-lg', 'overflow-hidden');

                const link = document.createElement('a');
                link.href = `/restaurant/restaurant/${restaurant.id}`;
                link.target = "_blank";
                link.rel = "noopener noreferrer";
                link.classList.add('block', 'hover:opacity-75', 'transition-opacity', 'duration-300');

                const img = document.createElement('img');
                const typeValue = restaurant.food_preference
                    ? restaurant.food_preference.split(',')[0].trim().replace(/\s+/g, '')
                    : 'placeholder';
                img.src = `/static/images/preferences/${typeValue}.jpg`;  // Adjust the extension if your images are .png
                img.alt = restaurant.name || 'Restaurant Image';
                img.classList.add('object-cover', 'w-full', 'h-64', 'md:h-full');

                link.appendChild(img);
                const imageDiv = document.createElement('div');
                imageDiv.classList.add('md:w-1/3', 'w-full');
                imageDiv.appendChild(link);

                // Restaurant details
                const detailsDiv = document.createElement('div');
                detailsDiv.classList.add('md:w-2/3', 'w-full', 'p-6', 'flex', 'flex-col', 'justify-between');

                // Name with hyperlink
                const nameLink = document.createElement('a');
                nameLink.href = `/restaurant/restaurant/${restaurant.id}`;
                nameLink.target = "_blank";
                nameLink.rel = "noopener noreferrer";
                nameLink.classList.add('text-2xl', 'font-bold', 'text-gray-800', 'mb-4');
                nameLink.textContent = restaurant.name || 'Unnamed Restaurant';

                const rating = document.createElement('p');
                rating.classList.add('text-gray-600', 'mb-2');
                rating.textContent = `Rating: ${restaurant.rating || 0} / 5`;

                const price = document.createElement('p');
                price.classList.add('text-gray-600', 'mb-2');
                price.textContent = `Average Price: Rp ${restaurant.average_price || 0}`;

                const type = document.createElement('p');
                type.classList.add('text-gray-600', 'mb-2');
                type.textContent = `Food Preference: ${restaurant.food_preference || 'Unknown'}`;

                const atmosphere = document.createElement('p');
                atmosphere.classList.add('text-gray-600', 'mb-2');
                atmosphere.textContent = `Atmosphere: ${restaurant.atmosphere || 'Unknown'}`;

                const foodVariety = document.createElement('p');
                foodVariety.classList.add('text-gray-600', 'mb-4');
                foodVariety.textContent = `Food Variety: ${restaurant.food_variety || 'Unknown'}`;

                // Append details to the card
                detailsDiv.appendChild(nameLink);
                detailsDiv.appendChild(rating);
                detailsDiv.appendChild(price);
                detailsDiv.appendChild(type);
                detailsDiv.appendChild(atmosphere);
                detailsDiv.appendChild(foodVariety);

                // Append image and details to the card
                card.appendChild(imageDiv);
                card.appendChild(detailsDiv);

                restaurantList.appendChild(card);
            });
        }

        // Event listeners for search and filter
        document.getElementById('search-input').addEventListener('input', function() {
            filterRestaurants();
        });

        document.getElementById('type-filter').addEventListener('change', function() {
            filterRestaurants();
        });

        function filterRestaurants() {
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;

            const filteredRestaurants = restaurantsData.filter(restaurant => {
                const matchesName = restaurant.name && restaurant.name.toLowerCase().includes(searchInput);
                const matchesType = !typeFilter || (restaurant.food_preference && restaurant.food_preference.includes(typeFilter));
                return matchesName && matchesType;
            });

            renderRestaurants(filteredRestaurants);
        }
    </script>
    {% endblock %}
</body>

</html>
{% endblock %}
